<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Homerlex</title>
  <!-- Pretendard 폰트 로드 (출처: Pretendard GitHub) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/static/pretendard.css">
  <style>
    body {
      font-family: 'Pretendard', sans-serif;
      background: linear-gradient(135deg, #e0e5ec, #f0f0f3);
      margin: 0;
      padding: 20px;
    }
    /* 툴바 중앙 정렬 */
    .toolbar {
      display: flex;
      gap: 10px;
      margin: 0 auto 20px auto;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
    }
    .toolbar button {
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      background: #e0e5ec;
      box-shadow: 5px 5px 10px #a3b1c6, -5px -5px 10px #ffffff;
      cursor: pointer;
      font-size: 14px;
      font-family: 'Pretendard', sans-serif;
      font-weight: 600; /* Pretendard Semibold */
      outline: none;
      transition: box-shadow 0.2s ease;
    }
    .toolbar button:hover {
      box-shadow: inset 5px 5px 10px #a3b1c6, inset -5px -5px 10px #ffffff;
    }
    /* 원형 컬러피커: 텍스트 컬러 설정용 */
    .toolbar input[type="color"] {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 50%;
      padding: 0;
      cursor: pointer;
      background: transparent;
    }
    .toolbar select {
      padding: 8px;
      border: none;
      border-radius: 10px;
      background: #e0e5ec;
      box-shadow: 5px 5px 10px #a3b1c6, -5px -5px 10px #ffffff;
      font-family: 'Pretendard', sans-serif;
      font-weight: 600;
      outline: none;
      cursor: pointer;
    }
    .editor {
      width: 100%;
      height: 400px;
      border: none;
      border-radius: 20px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      box-shadow: inset 5px 5px 10px #a3b1c6, inset -5px -5px 10px #ffffff;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      overflow: auto;
      position: relative;
    }
    .editor b,
    .editor strong {
      font-weight: 600;
    }
    /* 기본 Highlight 스타일 (초기 하이라이트 색상은 노란빛) */
    .highlight {
      border-radius: 8px;
      padding: 2px 4px;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      position: relative;
      /* 아래 스타일은 updateHighlightStyle()에서 덮어씌워집니다. */
      background-color: rgba(255, 255, 0, 0.3);
      box-shadow: 0px 0px 12px rgba(255, 255, 0, 0.5);
      border: 1px solid rgba(255, 255, 0, 0.4);
      color: #000;
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <button id="btnBold" title="Bold (Ctrl+B)">Bold</button>
    <button id="btnUnderline" title="Underline (Ctrl+U)">Underline</button>
    <button id="btnHighlight" title="Apply Highlight (Ctrl+H)">Highlight</button>
    <button id="btnRemoveHighlight" title="Remove Highlight (Ctrl+R)">Remove Highlight</button>
    <!-- 텍스트 컬러 설정용 컬러피커 -->
    <input type="color" id="textColor" title="Choose Text Color (Ctrl+T)" value="#007AFF">
    <!-- 저장 확장자 선택: .hom, .txt, .docx -->
    <select id="saveType" title="Save as (Ctrl+S)">
      <option value="hom">.hom</option>
      <option value="txt">.txt</option>
      <option value="docx">.docx</option>
    </select>
    <button id="btnSave" title="Save (Ctrl+S)">Save</button>
    <button id="btnUndo" title="Undo (Ctrl+Z)">Undo</button>
    <button id="btnRedo" title="Redo (Ctrl+Y)">Redo</button>
    <button id="btnLoad" title="Load File (Ctrl+O)">Load</button>
    <input type="file" id="fileLoad" accept=".hom,.txt,.docx" style="display: none;">
  </div>

  <div class="editor" contenteditable="true" id="editor">
    여기에 메모를 입력하세요...
  </div>

  <script>
    // 헬퍼 함수: HEX 값을 rgba 문자열로 변환 (alpha 포함)
    function hexToRgba(hex, alpha) {
      hex = hex.replace('#', '');
      if (hex.length === 3) {
        hex = hex.split('').map(c => c + c).join('');
      }
      const r = parseInt(hex.substring(0, 2), 16);
      const g = parseInt(hex.substring(2, 4), 16);
      const b = parseInt(hex.substring(4, 6), 16);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }
    
    // 하이라이트 스타일 업데이트: 텍스트 컬러 피커 값 적용 + Bold 적용
    function updateHighlightStyle(element) {
      const color = document.getElementById('textColor').value;
      element.style.backgroundColor = hexToRgba(color, 0.2);
      element.style.boxShadow = `0px 0px 12px ${hexToRgba(color, 0.4)}`;
      element.style.border = `1px solid ${hexToRgba(color, 0.3)}`;
      element.style.color = color;
      element.style.fontWeight = '600';
    }
    
    // 하이라이트 적용: 이미 하이라이트된 경우는 선택 해제
    function applyHighlight() {
      const selection = window.getSelection();
      if (selection.isCollapsed) return;
      const range = selection.getRangeAt(0);
      let container = range.commonAncestorContainer;
      if (container.nodeType === Node.TEXT_NODE) {
        container = container.parentElement;
      }
      if (container && container.classList && container.classList.contains('highlight')) {
        selection.removeAllRanges();
        return;
      }
      const span = document.createElement('span');
      span.className = 'highlight';
      updateHighlightStyle(span);
      span.appendChild(range.extractContents());
      range.insertNode(span);
      selection.removeAllRanges();
    }
    
    // 하이라이트 해제: highlight span을 풀어냄
    function removeHighlight() {
      const selection = window.getSelection();
      if (selection.isCollapsed) return;
      const range = selection.getRangeAt(0);
      let container = range.commonAncestorContainer;
      if (container.nodeType === Node.TEXT_NODE) {
        container = container.parentElement;
      }
      if (container && container.classList && container.classList.contains('highlight')) {
        const parent = container.parentNode;
        while (container.firstChild) {
          parent.insertBefore(container.firstChild, container);
        }
        parent.removeChild(container);
        selection.removeAllRanges();
      }
    }
    
    // 텍스트 컬러 변경: 컬러피커 변경 시 선택된 텍스트에 적용 (execCommand)
    document.getElementById('textColor').addEventListener('change', function() {
      const color = this.value;
      document.execCommand('foreColor', false, color);
    });
    
    // 저장 기능: 선택한 확장자에 따라 저장 (.hom은 JSON, .txt는 순수 텍스트, .docx는 HTML 래퍼)
    function saveContent() {
      const editor = document.getElementById('editor');
      const ext = document.getElementById('saveType').value;
      let content = '';
      if(ext === 'hom') {
        const data = {
          version: "1.0",
          content: editor.innerHTML
        };
        content = JSON.stringify(data);
      } else if(ext === 'txt') {
        content = editor.innerText;
      } else if(ext === 'docx') {
        content = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Homerlex Document</title>
</head>
<body>${editor.innerHTML}</body>
</html>`;
      }
      const blob = new Blob([content], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `homerlex_note.${ext}`;
      a.click();
      URL.revokeObjectURL(a.href);
    }
    
    // 파일 불러오기: 확장자에 따라 에디터에 로드
    function loadFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      const ext = file.name.split('.').pop().toLowerCase();
      const reader = new FileReader();
      reader.onload = function(e) {
        if (ext === 'hom') {
          try {
            const data = JSON.parse(e.target.result);
            if (data.version && data.content) {
              document.getElementById('editor').innerHTML = data.content;
              return;
            }
          } catch (err) {
            console.error("HOM 파일 파싱 에러:", err);
          }
          document.getElementById('editor').innerText = e.target.result;
        } else if (ext === 'txt') {
          document.getElementById('editor').innerText = e.target.result;
        } else if (ext === 'docx') {
          const parser = new DOMParser();
          const doc = parser.parseFromString(e.target.result, "text/html");
          document.getElementById('editor').innerHTML = doc.body.innerHTML;
        } else {
          document.getElementById('editor').innerText = e.target.result;
        }
      };
      reader.readAsText(file);
    }
    
    // 버튼 이벤트 리스너
    document.getElementById('btnBold').addEventListener('click', () => document.execCommand('bold'));
    document.getElementById('btnUnderline').addEventListener('click', () => document.execCommand('underline'));
    document.getElementById('btnHighlight').addEventListener('click', applyHighlight);
    document.getElementById('btnRemoveHighlight').addEventListener('click', removeHighlight);
    document.getElementById('btnSave').addEventListener('click', saveContent);
    document.getElementById('btnUndo').addEventListener('click', () => document.execCommand('undo'));
    document.getElementById('btnRedo').addEventListener('click', () => document.execCommand('redo'));
    document.getElementById('btnLoad').addEventListener('click', () => document.getElementById('fileLoad').click());
    document.getElementById('fileLoad').addEventListener('change', loadFile);
    
    // 단축키 지원: Ctrl+B, Ctrl+U, Ctrl+H, Ctrl+R, Ctrl+S, Ctrl+O, Ctrl+Z, Ctrl+Y, Ctrl+T (텍스트 컬러)
    document.addEventListener('keydown', function(event) {
      if (event.ctrlKey) {
        switch (event.key.toLowerCase()) {
          case 'b':
            event.preventDefault();
            document.execCommand('bold');
            break;
          case 'u':
            event.preventDefault();
            document.execCommand('underline');
            break;
          case 'h':
            event.preventDefault();
            applyHighlight();
            break;
          case 'r':
            event.preventDefault();
            removeHighlight();
            break;
          case 's':
            event.preventDefault();
            saveContent();
            break;
          case 'o':
            event.preventDefault();
            document.getElementById('fileLoad').click();
            break;
          case 'z':
            event.preventDefault();
            document.execCommand('undo');
            break;
          case 'y':
            event.preventDefault();
            document.execCommand('redo');
            break;
          case 't':
            event.preventDefault();
            document.getElementById('textColor').click();
            break;
        }
      }
    });
  </script>
</body>
</html>
