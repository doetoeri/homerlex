<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Homerlex – Collaborative Word Processor</title>
  <link rel="icon" href="icon.png" type="image/png" />
  <!-- Pretendard 폰트 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/static/pretendard.css" />
  <!-- Material Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
  <!-- PeerJS (데모 서버용 최신 버전) -->
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <style>
    :root {
      --primary: #0078D4;
      --on-primary: #ffffff;
      --surface: #ffffff;
      --on-surface: #323130;
      --background: #F3F2F1;
      --corner-radius: 10px;
      --font-family: 'Pretendard', sans-serif;
      --font-size: 16px;
      --icon-size: 28px;
      --button-padding: 0.75rem 1rem;
    }
    body {
      font-family: var(--font-family);
      font-weight: 600;
      margin: 20px;
      background-color: var(--background);
      color: var(--on-surface);
    }
    header {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      margin-bottom: 20px;
    }
    .logo {
      max-width: 100px;
      width: 100%;
      height: auto;
    }
    .tagline {
      font-size: 18px;
      color: var(--primary);
      margin-top: 5px;
    }
    /* 탭바 */
    #tabBar {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }
    .tab-btn {
      background-color: var(--surface);
      border: 1px solid #ccc;
      padding: 8px 16px;
      border-radius: var(--corner-radius);
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .tab-btn:hover {
      background-color: #e1e1e1;
    }
    .tab-btn.active {
      background-color: var(--primary);
      color: var(--on-primary);
      font-weight: bold;
      transform: scale(1.05);
    }
    .tab-btn.new-tab {
      font-size: 20px;
      font-weight: bold;
      background: none;
      border: none;
      padding: 8px;
    }
    /* 메모장 컨테이너 */
    #notepadContainer {
      width: 80%;
      max-width: 800px;
      margin: 0 auto 20px;
      border-radius: var(--corner-radius);
      background-color: var(--surface);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .notepad {
      padding: 20px;
      min-height: 400px;
      word-wrap: break-word;
      white-space: normal;
    }
    .notepad p {
      margin-top: 0;
      margin-bottom: 0;
      line-height: 1.5;
    }
    /* 하단 툴바 */
    #toolbar {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 10px;
      transition: all 0.3s ease;
    }
    .format-btn {
      background-color: var(--surface);
      color: var(--on-surface);
      border: none;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--corner-radius);
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease;
    }
    .format-btn:hover {
      background-color: #e1e1e1;
    }
    .format-btn:active {
      transform: scale(0.98);
    }
    .format-btn .material-icons {
      font-size: 24px;
    }
    #convertBtn {
      background-color: var(--primary);
      color: var(--on-primary);
      border: none;
      padding: var(--button-padding);
      border-radius: var(--corner-radius);
      font-size: var(--font-size);
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.1s ease;
    }
    #convertBtn:hover {
      background-color: rgba(255,255,255,0.3);
      color: var(--primary);
    }
    #convertBtn:active {
      transform: scale(0.98);
    }
    .highlight-btn {
      display: inline-block;
      background-color: var(--primary);
      border: none;
      padding: var(--button-padding);
      border-radius: var(--corner-radius);
      color: var(--on-primary);
      cursor: pointer;
      transition: transform 0.1s ease;
      margin: 2px 0;
    }
    .highlight-btn:hover {
      background-color: rgba(255,255,255,0.3);
      color: var(--primary);
    }
    .highlight-btn:active {
      transform: scale(0.97);
    }
    /* 공유 탭 동기화 영역 */
    #sharedSyncContainer {
      width: 80%;
      max-width: 800px;
      margin: 0 auto 24px;
      background-color: var(--surface);
      padding: 24px;
      border-radius: var(--corner-radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #sharedSyncContainer h2 {
      margin-top: 0;
      font-size: 20px;
      color: var(--primary);
    }
    #sharedContent {
      width: 100%;
      height: 80px;
      font-family: var(--font-family);
      font-size: var(--font-size);
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      resize: none;
    }
    #syncButton {
      margin-top: 10px;
      padding: 8px 16px;
      background-color: var(--primary);
      color: var(--on-primary);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: var(--font-size);
      transition: background-color 0.3s ease;
    }
    #syncButton:hover {
      background-color: rgba(255,255,255,0.3);
      color: var(--primary);
    }
    /* 추가 기능 툴바 (제안, 공유) */
    #extraToolbar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin: 0 auto 24px;
    }
    #extraToolbar button {
      background-color: var(--primary);
      border: none;
      color: var(--on-primary);
      font-size: 16px;
      padding: 10px 16px;
      border-radius: var(--corner-radius);
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #extraToolbar button:hover {
      background-color: rgba(255,255,255,0.3);
      color: var(--primary);
    }
    /* 제안 목록 패널 */
    #proposalsPanel {
      width: 80%;
      max-width: 900px;
      margin: 0 auto 24px;
      padding: 16px;
      background-color: var(--surface);
      border-radius: var(--corner-radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: none;
    }
    #proposalsPanel h3 {
      margin: 0 0 12px;
      font-size: 20px;
    }
    #proposalsList {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #proposalsList li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      margin-bottom: 8px;
      border: 1px solid #ddd;
      border-radius: var(--corner-radius);
      background-color: var(--surface);
    }
    #proposalsList li:last-child {
      border-bottom: none;
    }
    #proposalsList button {
      background-color: var(--primary);
      border: none;
      color: var(--on-primary);
      font-size: 14px;
      padding: 6px 12px;
      border-radius: var(--corner-radius);
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #proposalsList button:hover {
      background-color: rgba(255,255,255,0.3);
      color: var(--primary);
    }
    /* 제안 모달 */
    .modal {
      display: none;
      position: fixed;
      z-index: 200;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: var(--surface);
      margin: 15% auto;
      padding: 24px;
      border-radius: var(--corner-radius);
      width: 80%;
      max-width: 500px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .modal-content textarea {
      width: 100%;
      height: 150px;
      font-size: var(--font-size);
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: var(--corner-radius);
      resize: vertical;
    }
    @media screen and (max-width: 600px) {
      #notepadContainer, #sharedSyncContainer { width: 100%; padding: 12px; }
      #toolbar, #extraToolbar { flex-direction: column; gap: 8px; }
      #tabBar { flex-direction: column; }
    }
  </style>
</head>
<body>
  <!-- 헤더 -->
  <header>
    <img src="logo.png" alt="Homerlex Logo" class="logo" />
    <div class="site-title">Homerlex</div>
  </header>

  <!-- 탭 영역 -->
  <div id="tabBar">
    <button class="tab-btn active" data-tab="1">Document 1</button>
    <button class="tab-btn new-tab" id="newTabBtn">
      <span class="material-icons">add</span>
    </button>
  </div>

  <!-- 노트패드 영역 -->
  <div id="notepadContainer">
    <div id="notepad" class="notepad" contenteditable="true">
      <p>여기에 메모를 작성하세요.<br>줄바꿈이 그대로 적용됩니다.</p>
    </div>
  </div>

  <!-- 서식 툴바 -->
  <div id="toolbar">
    <button class="format-btn" onclick="execCmd('bold')" title="굵게">
      <span class="material-icons">format_bold</span>
    </button>
    <button class="format-btn" onclick="execCmd('italic')" title="이탤릭">
      <span class="material-icons">format_italic</span>
    </button>
    <button class="format-btn" onclick="execCmd('underline')" title="밑줄">
      <span class="material-icons">format_underlined</span>
    </button>
    <button class="format-btn" onclick="execCmd('strikeThrough')" title="취소선">
      <span class="material-icons">strikethrough_s</span>
    </button>
    <button class="format-btn" onclick="execCmd('justifyLeft')" title="좌측 정렬">
      <span class="material-icons">format_align_left</span>
    </button>
    <button class="format-btn" onclick="execCmd('justifyCenter')" title="중앙 정렬">
      <span class="material-icons">format_align_center</span>
    </button>
    <button class="format-btn" onclick="execCmd('justifyRight')" title="우측 정렬">
      <span class="material-icons">format_align_right</span>
    </button>
    <button id="convertBtn" onclick="convertSelectedText()" title="텍스트 버튼 적용">
      <span class="material-icons">smart_button</span>
    </button>
  </div>

  <!-- 공유 탭 동기화 영역 (PeerJS 그룹 연결) -->
  <div id="sharedSyncContainer">
    <h2>공유 탭 동기화</h2>
    <div id="groupInfo"></div>
    <textarea id="sharedContent" placeholder="여기에 공유할 내용을 입력하세요."></textarea>
    <button id="syncButton">동기화 전송</button>
  </div>

  <!-- 추가 기능 툴바: 제안 보내기 및 공유하기 -->
  <div id="extraToolbar">
    <button onclick="openProposalModal()">제안 보내기</button>
    <button onclick="shareChannel()">공유하기</button>
  </div>

  <!-- 제안 목록 패널 -->
  <div id="proposalsPanel">
    <h3>제안 목록</h3>
    <ul id="proposalsList"></ul>
  </div>

  <!-- 제안 모달 -->
  <div id="proposalModal" class="modal">
    <div class="modal-content">
      <h3>변경 제안 보내기</h3>
      <textarea id="proposalText"></textarea>
      <div style="text-align:center; margin-top:16px;">
        <button onclick="submitProposal()">제안 보내기</button>
        <button onclick="closeProposalModal()" style="margin-left:8px;">취소</button>
      </div>
    </div>
  </div>
  <script>
    /* ── 그룹 기반 실시간 동기화 (PeerJS 연결) ── */
    // 그룹 및 기기 고유 설정
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = crypto.getRandomValues(new Uint8Array(1))[0] % 16;
        var v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    let groupID = localStorage.getItem('groupID');
    if (!groupID) {
      groupID = prompt("동기화할 그룹 ID를 입력하세요 (예: room1):", "room1") || "room1";
      localStorage.setItem('groupID', groupID);
    }
    let deviceSeed = localStorage.getItem('deviceSeed');
    if (!deviceSeed) {
      deviceSeed = groupID + "-" + generateUUID();
      localStorage.setItem('deviceSeed', deviceSeed);
    }
    console.log("Device Seed:", deviceSeed, "Group:", groupID);

    // 호스트 여부 결정: 호스트는 그룹의 중앙 브로드캐스터 역할을 수행합니다.
    var isHost = confirm("이 기기를 호스트로 지정하시겠습니까? (OK: 호스트, Cancel: 클라이언트)");
    var hostId = groupID + "-host"; // 고정 호스트 ID
    var peerId = isHost ? hostId : groupID + "-" + deviceSeed.substr(-5);

    // PeerJS 객체 생성 (무료 데모 서버 사용; HTTPS 환경에서 실행)
    var myPeer = new Peer(peerId, { host: "0.peerjs.com", secure: true, port: 443 });
    var connections = []; // 호스트가 관리할 클라이언트 연결 목록
    var hostConn = null;  // 클라이언트에서는 호스트와의 연결

    myPeer.on('open', function(id) {
      console.log("PeerJS 연결 완료. 내 ID:", id);
      document.getElementById("groupInfo").innerText = "그룹: " + groupID + " | 내 ID: " + id +
      </script>
  </body>
</html>
